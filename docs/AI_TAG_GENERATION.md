# AI Style Tag Generation System

## Overview

The ReFitD application uses artificial intelligence to automatically generate style tags for clothing products by analyzing product images. This document explains how the system works.

---

## Technology Stack

| Component | Technology | Purpose |
|-----------|------------|---------|
| AI Runtime | OpenAI | Vision and chat (OPENAI_API_KEY) |
| Canonical Tags | ReFitd pipeline | Generated at ingestion after scrape |
| Backend | Python/Flask | API endpoints and processing |
| Database | Supabase (PostgreSQL) | Tag storage |

---

## How It Works

### Step 1: Image Submission

When a user clicks the "AI Generate" button on a product page:

1. The system retrieves the product's primary image URL from Supabase storage
2. Canonical tags are generated in the pipeline (OpenAI vision) at ingestion
3. The product name and description are included for additional context

### Step 2: AI Analysis

The vision model receives a specialized prompt designed for fashion analysis:

```
You are a fashion expert analyzing clothing product images.

Analyze this product image and generate style tags that describe:
1. Overall aesthetic (minimal, streetwear, preppy, etc.)
2. Fit and silhouette (slim, oversized, tailored, etc.)
3. Pattern/print (solid, striped, graphic, etc.)
4. Material appearance (cotton, denim, knit, etc.)
5. Season suitability (summer, winter, all-season, etc.)
6. Occasion (casual, formal, everyday, etc.)
7. Color mood (neutral, bold, muted, earthy, etc.)
8. Notable details (pocket, collar, distressed, etc.)

Product name for context: [Product Name]

Return ONLY a JSON array of lowercase style tags.
Example: ["casual", "minimal", "cotton", "summer", "neutral", "slim"]

Generate 4-8 relevant tags for this product.
```

### Step 3: Response Validation

The AI's response is validated against a predefined vocabulary of approximately 100 approved style tags. This ensures consistency and prevents nonsensical or inappropriate tags.

### Step 4: Duplicate Prevention

Before saving, the system checks for duplicates by comparing generated tags against:

- **Inferred tags**: Tags already extracted during the original product scraping
- **Existing AI tags**: Tags previously generated by AI for this product
- **Curated tags**: Tags manually added by human curators

Comparison is case-insensitive to catch variations like "Casual" vs "casual".

### Step 5: Storage

New, unique tags are saved to the `ai_generated_tags` table in Supabase with:

- Product ID
- Tag value
- Field name (style_tag)
- Model name (moondream)
- Timestamp

---

## Valid Tag Vocabulary

Tags are organized into 8 categories:

### Aesthetic
minimal, maximalist, classic, modern, vintage, retro, bohemian, streetwear, preppy, athleisure, grunge, smart-casual, formal, business, workwear, loungewear

### Fit
slim, regular, relaxed, oversized, tailored, fitted, loose, cropped, longline, boxy

### Pattern
solid, striped, checked, plaid, printed, graphic, floral, geometric, abstract, camo, tie-dye

### Material Feel
cotton, linen, denim, leather, wool, synthetic, knit, woven, jersey, fleece, corduroy, satin

### Season
summer, winter, spring, fall, all-season, transitional

### Occasion
casual, formal, business, party, beach, outdoor, athletic, lounge, date-night, travel, everyday

### Color Mood
neutral, bold, muted, earthy, pastel, monochrome, colorful, dark, light, vibrant

### Details
pocket, zip, button, collar, hood, logo, embroidered, distressed, raw-hem, pleated

---

## Visual Distinction

Tags are color-coded in the user interface to indicate their source:

| Tag Source | Color | Description |
|------------|-------|-------------|
| Inferred | Blue (#e3f2fd) | Automatically extracted during web scraping |
| Human Curated | Purple (gradient) | Manually added by curators |
| AI Generated | Teal (#00bcd4) | Generated by AI vision analysis |

---

## Requirements

For AI features (canonical tagging at ingestion, viewer chat/embeddings):

1. **OpenAI API Key**: Set `OPENAI_API_KEY` in `.env`

---

## Fallback Behavior

If the vision model is unavailable or fails to analyze an image, the system falls back to basic keyword extraction from the product name:

| Product Name Contains | Fallback Tags |
|----------------------|---------------|
| t-shirt, tshirt | casual, cotton, everyday |
| shirt | smart-casual, woven, collar |
| jeans | denim, casual, everyday |
| jacket | outerwear, layering |
| blazer, suit | formal, tailored, business |
| shorts | casual, summer, relaxed |

---

## Database Schema

AI-generated tags are stored in a dedicated table:

```sql
CREATE TABLE ai_generated_tags (
    id SERIAL PRIMARY KEY,
    product_id TEXT NOT NULL,
    field_name TEXT NOT NULL DEFAULT 'style_tag',
    field_value TEXT NOT NULL,
    model_name TEXT DEFAULT 'moondream',
    confidence DECIMAL(3, 2),
    reasoning TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(product_id, field_name, field_value)
);
```

---

## Configuration Options

The tagging system can be configured with these parameters:

| Parameter | Default | Description |
|-----------|---------|-------------|
| max_tags | 8 | Maximum number of tags to generate per product |
| min_tags | 3 | Minimum tags required (fallback used if not met) |
| temperature | 0.3 | AI creativity level (lower = more consistent) |
| validate_tags | true | Only allow tags from approved vocabulary |

---

## Summary

The AI tag generation system provides an efficient way to automatically categorize clothing products based on visual analysis. By using a local vision model, the system maintains data privacy while providing consistent, vocabulary-controlled tags that enhance product searchability and organization.
